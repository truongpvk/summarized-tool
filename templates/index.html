<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Readdy AI - Text Summarization</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { primary: "#57b5e7", secondary: "#8dd3c7" },
            borderRadius: {
              none: "0px",
              sm: "4px",
              DEFAULT: "8px",
              md: "12px",
              lg: "16px",
              xl: "20px",
              "2xl": "24px",
              "3xl": "32px",
              full: "9999px",
              button: "8px",
            },
          },
        },
      };
    </script>

    <!-- Mammoth.js for DOCX -->
    <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

    <!-- PDF.js for PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css"
    />
    <style>
      :where([class^="ri-"])::before {
        content: "\f3c2";
      }
    </style>
  </head>
  <body class="bg-white min-h-screen">
    <main class="w-full">
      <section class="max-w-6xl mx-auto px-6 py-16">
        <div class="text-center mb-12">
          <h2 class="text-3xl font-bold text-gray-900 mb-4">
            Summarize Your Content
          </h2>
          <p class="text-gray-600 text-lg">
            Choose your preferred summarization method and get instant results
          </p>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="space-y-4">
              <label class="block text-lg font-semibold text-gray-900"
                >Input Text</label
              >
              <textarea
                id="inputText"
                placeholder="Paste your text here to get started with summarization..."
                class="w-full h-80 p-4 border border-gray-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-gray-700 text-sm leading-relaxed"
              ></textarea>
              <div class="flex items-center gap-4">
                <label
                  class="flex items-center cursor-pointer bg-gray-50 hover:bg-gray-100 px-4 py-2 rounded-lg transition-colors"
                >
                  <div class="w-5 h-5 flex items-center justify-center mr-2">
                    <i class="ri-upload-2-line text-gray-600"></i>
                  </div>
                  <span class="text-sm text-gray-700">Upload File</span>
                  <input
                    type="file"
                    class="hidden"
                    accept=".txt,.pdf,.docx"
                    id="fileUpload"
                  />
                </label>
                <span class="text-xs text-gray-500"
                  >Supports .txt, .pdf, .docx</span
                >
              </div>
            </div>

            <div class="space-y-4">
              <label class="block text-lg font-semibold text-gray-900"
                >Summary</label
              >
              <div
                id="outputText"
                class="relative w-full h-80 p-4 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 text-sm leading-relaxed overflow-y-auto"
              >
                <div id="output-text" class="text-gray-400 italic">
                  Your summary will appear here...
                </div>

                <!-- Timer đặt ở đây -->
                <div
                  id="timer"
                  class="absolute bottom-2 right-4 flex items-center"
                >
                  <span class="text-xs font-semibold text-gray-700 ml-2"
                    >0.00s</span
                  >
                </div>
              </div>
              <button
                id="copyButton"
                class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors text-sm text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                <div class="w-4 h-4 flex items-center justify-center">
                  <i class="ri-file-copy-line"></i>
                </div>
                Copy to Clipboard
              </button>
            </div>
          </div>

          <div
            class="flex flex-col sm:flex-row items-center justify-between gap-6 pt-6 border-t border-gray-100"
          >
            <div class="flex items-center gap-6">
              <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-gray-700"
                  >Summarization Mode:</span
                >
                <div class="flex items-center bg-gray-100 rounded-full p-1">
                  <button
                    id="extractiveBtn"
                    class="px-4 py-2 text-sm font-medium rounded-full transition-all duration-200 bg-primary text-white"
                  >
                    Extractive
                  </button>
                  <button
                    id="abstractiveBtn"
                    class="px-4 py-2 text-sm font-medium rounded-full transition-all duration-200 text-gray-600 hover:text-gray-800"
                  >
                    Abstractive
                  </button>
                </div>
              </div>
            </div>
            <button
              id="summarizeBtn"
              class="bg-primary text-white px-8 py-3 !rounded-button hover:bg-blue-600 transition-colors font-semibold whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              <span id="summarizeText">Summarize</span>
              <div
                id="loadingSpinner"
                class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"
              ></div>
            </button>
          </div>
        </div>
      </section>
    </main>
    <script id="summarization-toggle">
      let currentMode = "extractive";

      document.addEventListener("DOMContentLoaded", function () {
        const extractiveBtn = document.getElementById("extractiveBtn");
        const abstractiveBtn = document.getElementById("abstractiveBtn");

        function updateModeButtons() {
          if (currentMode === "extractive") {
            extractiveBtn.classList.add("bg-primary", "text-white");
            extractiveBtn.classList.remove(
              "text-gray-600",
              "hover:text-gray-800"
            );
            abstractiveBtn.classList.remove("bg-primary", "text-white");
            abstractiveBtn.classList.add(
              "text-gray-600",
              "hover:text-gray-800"
            );
          } else {
            abstractiveBtn.classList.add("bg-primary", "text-white");
            abstractiveBtn.classList.remove(
              "text-gray-600",
              "hover:text-gray-800"
            );
            extractiveBtn.classList.remove("bg-primary", "text-white");
            extractiveBtn.classList.add("text-gray-600", "hover:text-gray-800");
          }
        }

        extractiveBtn.addEventListener("click", function () {
          currentMode = "extractive";
          console.log("Current mode set to:", currentMode);
          
          updateModeButtons();
        });

        abstractiveBtn.addEventListener("click", function () {
          currentMode = "abstractive";
          console.log("Current mode set to:", currentMode); 
          updateModeButtons();
        });
      });
    </script>

    <script id="file-upload-handler">
      document.addEventListener("DOMContentLoaded", function () {
        const fileUpload = document.getElementById("fileUpload");
        const inputText = document.getElementById("inputText");

        fileUpload.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const ext = file.name.split(".").pop().toLowerCase();

          if (ext === "txt") {
            const reader = new FileReader();
            reader.onload = function (e) {
              inputText.value = e.target.result;
              checkInputText();
            };
            reader.readAsText(file);
          } else if (ext === "docx") {
            const reader = new FileReader();
            reader.onload = function (e) {
              const arrayBuffer = e.target.result;
              mammoth
                .extractRawText({ arrayBuffer: arrayBuffer })
                .then((result) => {
                  inputText.value = result.value;
                  checkInputText();
                })
                .catch((err) => alert("Lỗi đọc file DOCX: " + err.message));
            };
            reader.readAsArrayBuffer(file);
          } else if (ext === "pdf") {
            const reader = new FileReader();
            reader.onload = function (e) {
              const typedarray = new Uint8Array(e.target.result);

              pdfjsLib
                .getDocument({ data: typedarray })
                .promise.then((pdf) => {
                  let maxPages = pdf.numPages;
                  let countPromises = [];

                  for (let j = 1; j <= maxPages; j++) {
                    countPromises.push(
                      pdf.getPage(j).then((page) =>
                        page.getTextContent().then((content) => {
                          return content.items
                            .map((item) => item.str)
                            .join(" ");
                        })
                      )
                    );
                  }

                  return Promise.all(countPromises);
                })
                .then((texts) => {
                  inputText.value = texts.join("\n\n");
                  checkInputText();
                })
                .catch((error) => {
                  alert("Lỗi đọc file PDF: " + error.message);
                });
            };
            reader.readAsArrayBuffer(file);
          } else {
            alert("Chỉ hỗ trợ các tệp .txt, .docx, .pdf");
          }
        });
      });
    </script>

    <script id="summarization-process">
      document.addEventListener("DOMContentLoaded", function () {
        const inputText = document.getElementById("inputText");
        const outputText = document.getElementById("output-text");
        const summarizeBtn = document.getElementById("summarizeBtn");
        const summarizeText = document.getElementById("summarizeText");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const timerElement = document.getElementById("timer");
        const copyButton = document.getElementById("copyButton");

        function checkInputText() {
          summarizeBtn.disabled = inputText.value.trim().length === 0;
        }

        function updateUIForLoading() {
          summarizeBtn.disabled = true;
          summarizeText.textContent = "Processing...";
          loadingSpinner.classList.remove("hidden");
          timerElement.querySelector("span").textContent = "0.00s";
        }

        function resetUIAfterSummary() {
          summarizeBtn.disabled = false;
          summarizeText.textContent = "Summarize";
          loadingSpinner.classList.add("hidden");
        }

        async function summarizeTextHandler() {
          if (inputText.value.trim() === "") return;

          updateUIForLoading();
          let second = 0.0;

          const timerInterval = setInterval(() => {
            second += 0.01;
            timerElement.querySelector("span").textContent =
              second.toFixed(2) + "s";
          }, 10);

          try {
            const summary = await handleSummarize();
            
            if (summary === "No summary available.") {
              outputText.textContent = "No summary available.";
              outputText.classList.add("text-gray-400", "italic");
              return;
            }

            const save = await saveResponse(
              inputText.value.trim(),
              summary,
              currentMode,
              second.toFixed(2)
            );

            outputText.classList.remove("text-gray-400", "italic");
            outputText.classList.add("text-gray-700");
            outputText.innerHTML = `${summary.replace(/\n/g, "<br>")}`;
            
            clearInterval(timerInterval);

            copyButton.disabled = false;
          } catch (error) {
            outputText.textContent = "An error occurred.";
            console.error("Summarization failed:", error);
          } finally {
            resetUIAfterSummary();
          }
        }

        function handleCopy() {
          const textToCopy = outputText.textContent;
          navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = copyButton.innerHTML;
            copyButton.innerHTML =
              '<div class="w-4 h-4 flex items-center justify-center"><i class="ri-check-line"></i></div>Copied!';
            copyButton.disabled = true;
            setTimeout(() => {
              copyButton.innerHTML = originalText;
              copyButton.disabled = false;
            }, 1000);
          });
        }

        inputText.addEventListener("input", checkInputText);
        summarizeBtn.addEventListener("click", summarizeTextHandler);
        copyButton.addEventListener("click", handleCopy);

        window.checkInputText = checkInputText;
      });
    </script>

    <script id="summarize-handle">
      async function handleSummarize() {
        const inputText = document.getElementById("inputText").value.trim();

        if (!inputText) {
          showError("Please enter some text to summarize.");
          return "No summary available.";
        }

        const mode = currentMode == "extractive" ? 0 : 1;

        const url = `/summarize`;
        console.log({ text: inputText, mode: mode });
        
        try {
          const res = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ text: inputText, mode: mode }),
          });

          const data = await res.json();

          if (data.error) {
            showError(`Error: ${data.error}`);
            return "No summary available.";
          }

          return data.summary || "No summary available.";
        } catch (err) {
          console.error("Fetch error:", err);
          showError("An error occurred while summarizing.");
        }
      }

      function showError(message) {
        alert(message);
      }
    </script>

    <script id="response-saving-handle">
      async function saveResponse(input, response, mode, time) {
        const payload = { input, response, mode, time };

        try {
          const res = await fetch("/save_response", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await res.json();

          if (data.success) {
            console.log("Response saved successfully.");
          } else {
            console.error("Failed to save response:", data.error);
          }
        } catch (err) {
          console.error("Error saving response:", err);
        }
      }
    </script>
  </body>
</html>
